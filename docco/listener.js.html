<!DOCTYPE html>

<html>
<head>
  <title>listener.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="distributor.js.html">
                  distributor.js
                </a>


                <a class="source" href="intake.bin.js.html">
                  intake.bin.js
                </a>


                <a class="source" href="listener.js.html">
                  listener.js
                </a>


                <a class="source" href="router.bin.js.html">
                  router.bin.js
                </a>


                <a class="source" href="router.js.html">
                  router.js
                </a>


                <a class="source" href="socket.bin.js.html">
                  socket.bin.js
                </a>


                <a class="source" href="strawboss.js.html">
                  strawboss.js
                </a>


                <a class="source" href="subordinate.bin.js.html">
                  subordinate.bin.js
                </a>


                <a class="source" href="subordinate.js.html">
                  subordinate.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>listener.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The listener implements a Node.js Cluster “Master.” I call it a listener
because I think of it as listening to the bound port.</p>
<p>Our listener implementation starts the cluster workers. It uses the
<code>Cluster.setupMaster</code> method to specify a specific worker executable instead
of using the behavior that looks like fork yet behaves nothing like fork and
is therefore very confusing.</p>
<p>In case you ever forget; you must use cluster to support Windows. Your
support here should be enough to evolve a Windows implementation that is as
performant as Node.js can be on Windows. Windows is slow about passing
handles, so you shouldn’t roll your own handle passing strategy. It would
only work for TCP/TLS anyway. You can’t pass the TCP handles of an HTTP
server around and no your are not going to implement HTTP parsing.</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>From the Node.js API.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>)
<span class="hljs-keyword">var</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>)
<span class="hljs-keyword">var</span> children = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Common utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Control-flow utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> delta = <span class="hljs-built_in">require</span>(<span class="hljs-string">'delta'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> Signal = <span class="hljs-built_in">require</span>(<span class="hljs-string">'signal'</span>)</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Controlled demolition of objects.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Destructible = <span class="hljs-built_in">require</span>(<span class="hljs-string">'destructible'</span>)</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Exceptions that you can catch by type.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> interrupt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'interrupt'</span>).createInterrupter(<span class="hljs-string">'subordinate'</span>)</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Contextualized callbacks and event handlers.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Operation = <span class="hljs-built_in">require</span>(<span class="hljs-string">'operation/variadic'</span>)</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create a listener. The <code>secret</code> is used to indicate that a request has been
routed and is supposed to go to a specific worker.</p>

            </div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Listener</span> (<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">this</span>._secret = options.secret
    <span class="hljs-keyword">this</span>._listener = options.listener
    <span class="hljs-keyword">this</span>._count ={
        <span class="hljs-attr">listeners</span>: coalesce(options.program.ultimate.listeners, <span class="hljs-number">1</span>),
        <span class="hljs-attr">workers</span>: coalesce(options.program.ultimate.workers, <span class="hljs-number">1</span>)
    }
    <span class="hljs-keyword">this</span>._listeners = []
    <span class="hljs-keyword">this</span>._destructible = <span class="hljs-keyword">new</span> Destructible(<span class="hljs-string">'master'</span>)
    <span class="hljs-keyword">this</span>._destructible.markDestroyed(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._destructible.addDestructor(<span class="hljs-string">'kill'</span>, <span class="hljs-keyword">this</span>, <span class="hljs-string">'_kill'</span>)
    <span class="hljs-keyword">this</span>._argv = options.program.argv.slice()
    <span class="hljs-keyword">this</span>._command = <span class="hljs-keyword">this</span>._argv.shift()
}

Listener.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._destructible.destroy()
}</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><a href="https://groups.google.com/forum/#!msg/comp.unix.wizards/GNU3ZFJiq74/ZFeCKhnavkMJ">https://groups.google.com/forum/#!msg/comp.unix.wizards/GNU3ZFJiq74/ZFeCKhnavkMJ</a></p>

            </div>

            <div class="content"><div class='highlight'><pre>Listener.prototype._kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._listeners.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">listener</span>) </span>{ listener.kill() })
}

Listener.prototype.run = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    cluster.setupMaster({
        <span class="hljs-attr">exec</span>: path.join(__dirname, <span class="hljs-keyword">this</span>._listener.shift()),
        <span class="hljs-attr">argv</span>: <span class="hljs-keyword">this</span>._listener

    })
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>._count.listeners; i++) {
        <span class="hljs-keyword">var</span> listener = cluster.fork({ <span class="hljs-attr">SUBORDINATE_SECRET</span>: <span class="hljs-keyword">this</span>._secret })
        <span class="hljs-keyword">this</span>._listeners.push(listener)
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            delta(<span class="hljs-keyword">async</span>()).ee(listener).on(<span class="hljs-string">'exit'</span>)
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">code, signal</span>) </span>{
            interrupt.assert(<span class="hljs-keyword">this</span>.destroyed, <span class="hljs-string">'listener error exit'</span>, { <span class="hljs-attr">code</span>: code, <span class="hljs-attr">signal</span>: signal })
            <span class="hljs-keyword">return</span> []
        })
    }
})

<span class="hljs-built_in">module</span>.exports = Listener</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
