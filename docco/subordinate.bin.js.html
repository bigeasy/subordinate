<!DOCTYPE html>

<html>
<head>
  <title>subordinate.bin.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="distributor.js.html">
                  distributor.js
                </a>


                <a class="source" href="intake.bin.js.html">
                  intake.bin.js
                </a>


                <a class="source" href="listener.js.html">
                  listener.js
                </a>


                <a class="source" href="router.bin.js.html">
                  router.bin.js
                </a>


                <a class="source" href="router.js.html">
                  router.js
                </a>


                <a class="source" href="socket.bin.js.html">
                  socket.bin.js
                </a>


                <a class="source" href="strawboss.js.html">
                  strawboss.js
                </a>


                <a class="source" href="subordinate.bin.js.html">
                  subordinate.bin.js
                </a>


                <a class="source" href="subordinate.js.html">
                  subordinate.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>subordinate.bin.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-comment">/*
    ___ usage ___ en_US ___
    usage: subordinate &lt;options&gt; [worker]

    options:

    -k, --key &lt;string&gt;

        Either a JavaScript expression or the name of a module that exports an
        extracotr function. The expression will be evaulated as a JavaScript
        function that accepts a single `$` parameter.

        If the character `$` is present in the value it will evaluated as a
        JavaScript expression, otherwise it will be loaded as a module.

        The `$` parameter is an object with the properties `headers`, `method`,
        `url`, `path`, and `parts`. `headers` is an object containing request
        headers. `method` is the request method. `url` is the parsed url. `path`
        is the path of the url. `parts` is an array containing the path split
        on `/` with the leading empty string removed.

        If you choose to provide a module it will receive the object `$`
        describe above. It should return a JSON

    -b, --bind &lt;string&gt;

        The port or unix domain socket to bind to.

        If the bind argument begins with a `.` or `/` it will be interpreted as
        a path to a domain socket.

    -w, --workers &lt;number&gt;

    -s, --secret &lt;string&gt;

        Secret used to authenticate specific worker routing. Exposing workers by
        index will not be commonly useful, but it is needed sometimes during
        development.

    ___ $ ___ en_US ___

    ___ . ___
*/</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'arguable'</span>)(<span class="hljs-built_in">module</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, program</span>) </span>{
    <span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)
    <span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)
    <span class="hljs-keyword">var</span> Cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./cluster'</span>)
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^[\/.]/</span>.test(program.ultimate.bind)) {
        program.validate(<span class="hljs-built_in">require</span>(<span class="hljs-string">'arguable/bindable'</span>), <span class="hljs-string">'bind'</span>)
    }
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> secret = coalesce(program.env.SUBORDINATE_SECRET, program.ultimate.secret)
        <span class="hljs-keyword">if</span> (secret) {
            <span class="hljs-keyword">return</span> [ secret ]
        }
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            crypto.randomBytes(<span class="hljs-number">256</span>, <span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer</span>) </span>{
            <span class="hljs-keyword">return</span> [ buffer.toString(<span class="hljs-string">'hex'</span>) ]
        })
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">secret</span>) </span>{
        <span class="hljs-keyword">var</span> cluster = <span class="hljs-keyword">new</span> Cluster(program, secret)
        cluster.run(<span class="hljs-keyword">async</span>())
        program.on(<span class="hljs-string">'shutdown'</span>, cluster.destroy.bind(cluster))
    })
}))</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
